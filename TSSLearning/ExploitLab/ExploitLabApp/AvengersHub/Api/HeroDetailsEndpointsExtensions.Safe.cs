namespace ExploitLabApp.AccountManagement.Api;

using ExploitLabApp.Heroes.Application;
using System.Net.Mime;
using System.Text;

public static class HeroDetailsEndpointsSafeExtensions
{
  public static void MapHeroDetailsSafeEndpoints(this IEndpointRouteBuilder app)
  {
    // TODO
    // Secure field with: 
    // <td>Ah ah ah <img src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M14.31 8l5.74 9.94"/></svg>' onload="alert('Cross-Site attack!')"/></td>

    app.MapGet("/api/heroes/details/{heroName}", async (IHeroesRepository repo, string heroName) =>
    {
      StringBuilder sb = new StringBuilder();
      sb
      .AppendLine("<html>")
      .AppendLine("<body>");

      var heroes = await repo.GetByPatternAsync(heroName);
      foreach (var hero in heroes)
      {
        sb
        .Append("<h1>")
        .Append(hero.HeroName)
        .AppendLine("</h1>")
        .Append("<h2>")
        .Append($"Power: {hero.Power}")
        .AppendLine("</h2>")
        .AppendLine($"<p>Email: {hero.Email}</p>");
      }

      sb
      .AppendLine("</body>")
      .AppendLine("</html>");

      return Results.Content(sb.ToString(), MediaTypeNames.Text.Html, Encoding.UTF8);
    });

  }
}
