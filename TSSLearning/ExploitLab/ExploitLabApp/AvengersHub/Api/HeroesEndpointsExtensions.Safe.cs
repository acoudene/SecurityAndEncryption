namespace ExploitLabApp.AccountManagement.Api;

using ExploitLabApp.IdentityProvider.Api;
using ExploitLabApp.Heroes.Application;
using ExploitLabApp.Heroes.Domain;
using ExploitLabApp.AvengersHub.Api;

public static class HeroesEndpointsSafeExtensions
{
  public static void MapHeroesSafeEndpoints(this IEndpointRouteBuilder app)
  {
    app.MapGet("/api/heroes", async (IHeroesRepository repo, string? searchPattern) =>
    {
      var heroes = await repo.GetByPatternAsync(searchPattern);
      return Results.Ok(heroes.Select(u => new HeroReadDto(u.HeroName, u.Power, u.Email)));
    });

    app.MapGet("/api/heroes/{heroName}", async (IHeroesRepository repo, string heroName) =>
    {
      var heroes = await repo.GetByPatternAsync(heroName);
      return Results.Ok(heroes.Select(u => new HeroReadDto(u.HeroName, u.Power, u.Email)));
    });

    app.MapPost("/api/heroes", async (IHeroesRepository repo, HeroCreationDto dto) =>
    {
      var hero = new Hero() { HeroName = dto.HeroName, Power = dto.Power, Email = dto.Email };
      await repo.AddAsync(hero);
      return Results.Created($"/api/heroes/{hero.HeroName}", new HeroReadDto(hero.HeroName, hero.Power, hero.Email));
    });

  }
}
