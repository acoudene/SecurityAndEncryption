using ExploitLabApp.Heroes.Application;
using ExploitLabApp.Heroes.Domain;
using Microsoft.Data.Sqlite;

namespace ExploitLabApp.Heroes.Infrastructure;

public class HeroesSqliteRepository : IHeroesRepository
{
  private readonly string _connectionString;

  public HeroesSqliteRepository(string connectionString)
  {
    if (string.IsNullOrWhiteSpace(connectionString))
      throw new ArgumentNullException(nameof(connectionString));

    _connectionString = connectionString;
  }

  protected List<Hero> GetByCommand(Action<SqliteCommand> SetCommand)
  {
    List<Hero> readHeroes = Enumerable.Empty<Hero>().ToList();

    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      using var cmd = conn.CreateCommand();
      SetCommand(cmd);
      using var reader = cmd.ExecuteReader();
      while (reader.Read())
      {
        string name = reader.GetString(0);
        string firstName = reader.GetString(1);
        string email = reader.GetString(2);
        readHeroes.Add(new Hero { Name = name, FirstName = firstName, Email = email });
      }
    }

    return readHeroes;
  }  

  public Task<List<Hero>> GetByPatternAsync(string? searchPattern = null)
  {
    return Task.FromResult(GetByCommand(cmd => SetReadHeroesCommand(cmd, searchPattern)));
  }

  public Task AddAsync(Hero hero)
  {
    string name = hero.Name;
    string firstName = hero.FirstName;
    string email = hero.Email;

    if (string.IsNullOrWhiteSpace(name))
      throw new ArgumentException("Name is required", nameof(hero));
    if (string.IsNullOrWhiteSpace(firstName))
      throw new ArgumentException("FirstName is required", nameof(hero));
    if (string.IsNullOrWhiteSpace(email))
      throw new ArgumentException("Email is required", nameof(hero));

    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      using var cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (Name, FirstName, Email) VALUES ('{name}', '{firstName}', '{email}');";
      int rows = cmd.ExecuteNonQuery();
      if (rows != 1)
        throw new InvalidOperationException("Error during hero creation");
    }

    return Task.CompletedTask;
  }

  public static void SetReadHeroesCommand(SqliteCommand readcommand, string? searchPattern = null)
  {
    string sqlBaseQuery = $"SELECT Name, FirstName, Email FROM Heroes";
    if (string.IsNullOrWhiteSpace(searchPattern))
    {
      readcommand.CommandText = $"{sqlBaseQuery};";
      return;
    }
    string where = $"WHERE Name LIKE '%{searchPattern}%' OR FirstName LIKE '%{searchPattern}%' OR Email LIKE '%{searchPattern}%';";
    readcommand.CommandText = $"{sqlBaseQuery} {where}";
  }
}
