namespace ExploitLabApp.Shared.Infrastructure;

using Microsoft.Data.Sqlite;

public class SqliteSeeding
{
  private readonly string _connectionString;

  public SqliteSeeding(string connectionString)
  {
    if (string.IsNullOrWhiteSpace(connectionString))
      throw new ArgumentNullException(nameof(connectionString));

    _connectionString = connectionString;
  }

  public void EnsureDatabases()
  {
    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      var cmd = conn.CreateCommand();
      cmd.CommandText = @"DROP TABLE IF EXISTS Heroes; 
                          CREATE TABLE Heroes (Name TEXT NOT NULL, Firstname TEXT NOT NULL, Email TEXT NOT NULL);";
      cmd.ExecuteNonQuery();
      cmd.CommandText = @"DROP TABLE IF EXISTS HashedSecrets; 
                          CREATE TABLE HashedSecrets (key TEXT PRIMARY KEY, hash TEXT NOT NULL);";      
      cmd.ExecuteNonQuery();
      cmd.CommandText = @"DROP TABLE IF EXISTS SecretIdentities; 
                          CREATE TABLE SecretIdentities (heroName TEXT PRIMARY KEY, realName TEXT NOT NULL, realFirstName TEXT NOT NULL);";      
      cmd.ExecuteNonQuery();
    }
  }

  public void Seed()
  {
    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      var cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (Name, FirstName, Email) VALUES ('Man', 'Iron', 'ironman@avengers.hub')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (Name, FirstName, Email) VALUES ('America', 'Captain', 'captain.america@avengers.us')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (Name, FirstName, Email) VALUES ('Panther', 'Black', 'black.panther@avengers.wk')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO HashedSecrets (key, hash) VALUES ('{Guid.NewGuid()}', 'a97f291da02137d38a5221edf5ad4dba698e5108c545a64c2048b15e21dd0669')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO HashedSecrets (key, hash) VALUES ('{Guid.NewGuid()}', 'b56a372cb13452a45b6324cab6ca3dba698b4134a265b34c2155c25a32ac1528')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = "INSERT INTO SecretIdentities (heroName, realName, realFirstName) VALUES ('Superman', 'Kent', 'Clark')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = "INSERT INTO SecretIdentities (heroName, realName, realFirstName) VALUES ('Spiderman', 'Parker', 'Peter')";
      cmd.ExecuteNonQuery();
    }
  }
}
