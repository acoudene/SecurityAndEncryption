namespace ExploitLabApp.Shared.Infrastructure;

using Microsoft.Data.Sqlite;

public class SqliteSeeding
{
  private readonly string _connectionString;

  public SqliteSeeding(string connectionString)
  {
    if (string.IsNullOrWhiteSpace(connectionString))
      throw new ArgumentNullException(nameof(connectionString));

    _connectionString = connectionString;
  }

  public void EnsureDatabases()
  {
    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      var cmd = conn.CreateCommand();
      cmd.CommandText = @"DROP TABLE IF EXISTS Heroes; 
                          CREATE TABLE Heroes (HeroName TEXT NOT NULL, Power TEXT NOT NULL, Email TEXT NOT NULL);";
      cmd.ExecuteNonQuery();
      cmd.CommandText = @"DROP TABLE IF EXISTS HashedSecrets; 
                          CREATE TABLE HashedSecrets (Key TEXT PRIMARY KEY, Hash TEXT NOT NULL);";      
      cmd.ExecuteNonQuery();
      cmd.CommandText = @"DROP TABLE IF EXISTS SecretIdentities; 
                          CREATE TABLE SecretIdentities (HeroName TEXT PRIMARY KEY, RealName TEXT NOT NULL, RealFirstName TEXT NOT NULL);";      
      cmd.ExecuteNonQuery();
    }
  }

  public void Seed()
  {
    using (var conn = new SqliteConnection(_connectionString))
    {
      conn.Open();
      var cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (HeroName, Power, Email) VALUES ('Iron Man', 'Genius inventor', 'ironman@avengers.hub')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (HeroName, Power, Email) VALUES ('Captain America', 'Enhanced strength', 'captain.america@avengers.us')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO Heroes (HeroName, Power, Email) VALUES ('Black Panther', 'Vibranium technology', 'black.panther@avengers.wk')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO HashedSecrets (Key, Hash) VALUES ('{Guid.NewGuid()}', 'a97f291da02137d38a5221edf5ad4dba698e5108c545a64c2048b15e21dd0669')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = $"INSERT INTO HashedSecrets (Key, Hash) VALUES ('{Guid.NewGuid()}', 'b56a372cb13452a45b6324cab6ca3dba698b4134a265b34c2155c25a32ac1528')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = "INSERT INTO SecretIdentities (HeroName, RealName, RealFirstName) VALUES ('Superman', 'Kent', 'Clark')";
      cmd.ExecuteNonQuery();
      cmd = conn.CreateCommand();
      cmd.CommandText = "INSERT INTO SecretIdentities (HeroName, RealName, RealFirstName) VALUES ('Spiderman', 'Parker', 'Peter')";
      cmd.ExecuteNonQuery();
    }
  }
}
