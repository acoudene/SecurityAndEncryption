@page "/"
@page "/users"
@using Microsoft.AspNetCore.Components.Forms
@using Microsoft.AspNetCore.Components.Web
@using Microsoft.AspNetCore.Mvc
@using _01_SqlInjectionApp.IdentityProvider.Api
@using _01_SqlInjectionApp.Users.Infrastructure

<h1>Users</h1>

<div class="mb-3 d-flex">
  <button @onclick="ReloadPage">
    Reload
  </button>
</div>

@if (_users is null)
{
  <p><em>Loading...</em></p>
}
else
{ 
  <div class="mb-3 d-flex">
    <InputText placeholder="Search by pattern..." @bind-value="SearchPattern" />
    <button type="button" class="btn btn-primary" onclick="@SearchUsersAsync">Search</button>
  </div>

  <table class="table">
    <thead>
      <tr>
        <th>Name</th>
        <th>FirstName</th>
        <th>Email</th>
      </tr>
    </thead>
    <tbody>
      @foreach (var user in _users)
      {
        <tr>
          <td>@user.Name</td>
          <td>@user.FirstName</td>
          <td>@user.Email</td>
        </tr>
      }
    </tbody>
  </table>

  <h2>Add</h2>

  <div>
    <EditForm OnValidSubmit="CreateAsync" Model="UserCreation" FormName="UserCreation">
      <div>
        Name: <InputText @bind-value="UserCreation.Name" class="form-control" />
      </div>
      <div>
        FirstName: <InputText @bind-value="UserCreation.FirstName" class="form-control" />
      </div>
      <div>
        Email: <InputText @bind-value="UserCreation.Email" class="form-control" />
      </div>
      <button type="submit" class="btn btn-primary">Create a new user</button>
    </EditForm>
  </div>  
}

@if (!string.IsNullOrWhiteSpace(_errorMessage))
{
  <div class="alert alert-danger d-flex justify-content-between align-items-center mt-3">
    <span>@_errorMessage</span>
    <button class="btn btn-light btn-sm ms-3" @onclick="ReloadPage">
      Reload
    </button>
  </div>
}

@code {

  private string? _errorMessage;

  [Inject]
  public required UsersProxySafeClient UsersClient { get; init; }

  [Inject]
  public required NavigationManager Navigation { get; init; }

  private List<UserReadDto>? _users;
  private string? SearchPattern { get; set; }

  [SupplyParameterFromForm]
  private UserCreationDto UserCreation { get; set; } = new() { Name = string.Empty, FirstName = string.Empty, Email = string.Empty };

  protected override async Task OnInitializedAsync()
  {
    try
    {
      _users = await UsersClient.SearchAsync();
    }
    catch(Exception ex)
    {
      _errorMessage = $"Error during user initialization: {ex.Message}";
    }
  }

  protected async Task CreateAsync()
  {
    try
    {
      var response = await UsersClient.CreateAsync(UserCreation);
      if (!response.IsSuccessStatusCode)
      {
        var problem = await response.Content.ReadFromJsonAsync<ProblemDetails>();
        _errorMessage = $"Error during user creation: {problem?.Detail ?? problem?.Status.ToString()}";
        return;
      }

      _users = await UsersClient.SearchAsync();
      StateHasChanged();
    }
    catch(Exception ex)
    {
      _errorMessage = $"Error during user creation: {ex.Message}";
    }
  }

  protected async Task SearchUsersAsync()
  {
    try
    {
      _users = await UsersClient.SearchAsync(SearchPattern);
      StateHasChanged();
    }
    catch(Exception ex)
    {
      _errorMessage = $"Error during user search: {ex.Message}";
    }
  }

  private void ReloadPage()
  {
    // recharge la page courante depuis le serveur
    Navigation.NavigateTo(Navigation.Uri, forceLoad: true);
  }
}
